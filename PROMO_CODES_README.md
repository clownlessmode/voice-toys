# Система Промокодов

## Обзор

Система промокодов позволяет создавать и управлять различными типами скидок для заказов. Поддерживаются два типа промокодов:

- **Процентная скидка** - скидка в процентах от суммы заказа
- **Фиксированная скидка** - скидка в рублях

## Возможности

### ✅ Создание промокодов

- Уникальный код промокода
- Название и описание
- Тип скидки (процент или сумма)
- Значение скидки
- Минимальная сумма заказа
- Максимальное количество использований
- Период действия (с - по)
- Статус активности

### ✅ Валидация промокодов

- Проверка существования кода
- Проверка активности
- Проверка срока действия
- Проверка лимита использований
- Проверка минимальной суммы заказа
- Автоматический расчет скидки

### ✅ Отслеживание использования

- Счетчик использований
- Связь с заказами
- Статистика по промокодам

### ✅ Административная панель

- Создание/редактирование/удаление промокодов
- Просмотр статистики использования
- Управление статусом активности

## Структура базы данных

### Таблица `promo_codes`

```sql
- id: уникальный идентификатор
- code: уникальный код промокода
- name: название промокода
- description: описание (опционально)
- type: тип промокода (PERCENTAGE/FIXED_AMOUNT)
- value: значение скидки
- minOrderAmount: минимальная сумма заказа
- maxUses: максимальное количество использований
- currentUses: текущее количество использований
- validFrom: дата начала действия
- validUntil: дата окончания действия
- isActive: статус активности
- createdAt: дата создания
- updatedAt: дата обновления
```

### Обновленная таблица `orders`

```sql
- promoCodeId: ссылка на использованный промокод
- discountAmount: сумма скидки
- originalAmount: исходная сумма заказа
```

## API Endpoints

### Промокоды

- `GET /api/promo-codes` - список промокодов с фильтрацией
- `POST /api/promo-codes` - создание нового промокода
- `GET /api/promo-codes/[id]` - получение промокода по ID
- `PATCH /api/promo-codes/[id]` - обновление промокода
- `DELETE /api/promo-codes/[id]` - удаление промокода

### Валидация

- `POST /api/promo-codes/validate` - валидация промокода

## Использование

### 1. Создание промокода в админке

1. Перейдите в `/admin/promo-codes`
2. Нажмите "Создать промокод"
3. Заполните форму:
   - **Код**: уникальный код (например, WELCOME20)
   - **Название**: понятное название
   - **Тип**: процентная или фиксированная скидка
   - **Значение**: размер скидки
   - **Минимальная сумма**: минимальная сумма заказа для применения
   - **Максимум использований**: лимит использований (0 = без лимита)
   - **Период действия**: с какой даты по какую действует
   - **Активен**: включить/выключить промокод

### 2. Применение промокода в заказе

1. В форме заказа введите код промокода
2. Нажмите "Применить"
3. Система проверит валидность и применит скидку
4. Скидка будет отражена в итоговой сумме

### 3. Отслеживание использования

- В админке видно количество использований каждого промокода
- При оплате заказа счетчик автоматически увеличивается
- Можно отслеживать эффективность промокодов

## Примеры промокодов

### Процентная скидка

```json
{
  "code": "WELCOME20",
  "name": "Добро пожаловать",
  "type": "PERCENTAGE",
  "value": 20,
  "minOrderAmount": 1000,
  "maxUses": 100,
  "validUntil": "2025-12-31"
}
```

**Результат**: Скидка 20% на заказы от 1000₽

### Фиксированная скидка

```json
{
  "code": "SAVE500",
  "name": "Экономия 500₽",
  "type": "FIXED_AMOUNT",
  "value": 500,
  "minOrderAmount": 2000,
  "maxUses": 50,
  "validUntil": "2025-11-30"
}
```

**Результат**: Скидка 500₽ на заказы от 2000₽

## Безопасность

- Промокоды проверяются на уникальность
- Валидация происходит на сервере
- Счетчик использований обновляется только при успешной оплате
- Промокоды можно деактивировать в любой момент

## Тестирование

Для тестирования системы используйте скрипт:

```bash
node scripts/test-promo-codes.js
```

Этот скрипт:

1. Создает тестовые промокоды
2. Проверяет валидацию
3. Создает тестовый заказ
4. Показывает статистику использования

## Интеграция с CDEK

При создании заказа в CDEK учитывается:

- Итоговая сумма заказа (после применения промокода)
- Вес и габариты товаров
- Информация о примененном промокоде

## Мониторинг

Рекомендуется регулярно проверять:

- Статистику использования промокодов
- Эффективность различных типов скидок
- Популярность промокодов
- Сроки действия активных промокодов
